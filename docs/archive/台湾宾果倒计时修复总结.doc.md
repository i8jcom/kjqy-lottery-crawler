# 台湾宾果倒计时修复总结

## 问题描述

1. **倒计时不准确**：倒计时比实际少了50秒
   - 表现：开奖号码出现时显示3分50秒，应该显示4分40秒

2. **倒计时跳跃不稳定**：一会显示5分30秒，一会3秒，一会归零
   - 原因：倒计时≤0时错误地重置为350秒，导致异常跳跃

## 根本原因

### 台湾宾果开奖时间线
```
16:50:00  ← 官方dDate（预定开奖时间）
    ↓
16:50:00-16:50:50  ← 开奖进行中（50秒）
    ↓
16:50:50  ← 号码出现在官方API（实际完成时间）
    ↓
下一期:
16:55:00  ← 官方dDate（预定开奖时间）
16:55:50  ← 号码出现（实际完成时间）
```

**关键理解**：
- 官方API的 `dDate` 字段 = 预定开奖时间（整分钟）
- 实际号码出现时间 = `dDate + 50秒`
- 每期间隔 = 300秒（5分钟）
- 用户看到的"倒计时" = 距离下一期号码出现的时间

## 修复方案

### 1. TaiwanBingoScraper.js（不修改）
- 保持官方 `dDate` 原样，不做任何偏移
- `drawTime` 字段直接使用官方的预定开奖时间

### 2. MultiSourceDataManager.js（核心修复）

**修改位置**：`src/services/MultiSourceDataManager.js` 第742-754行

**修复逻辑**：
```javascript
// 🎯 台湾宾果特殊处理：实际开奖完成时间 = 预定时间 + 50秒
const drawDelaySeconds = (lotCode === '100007') ? 50 : 0;
const nextDrawTime = new Date(lastDrawTime.getTime() + (intervalSeconds + drawDelaySeconds) * 1000);

// 🎯 计算倒计时（如果≤0，返回0，前端显示"开奖中"）
calculatedCountdown = Math.max(0, Math.floor((nextDrawTime.getTime() - now.getTime()) / 1000));
```

**计算示例**：
```
当前期号: 115000938 (dDate = 17:30:00)
下期预定时间: 17:30:00 + 300秒 = 17:35:00
下期实际完成: 17:35:00 + 50秒 = 17:35:50
当前时间: 17:34:27
倒计时: 17:35:50 - 17:34:27 = 83秒 ✓
```

### 3. 前端 Realtime.vue（已有逻辑）

**关键机制**：
- 倒计时归零后 → 显示"开奖中"
- 清空旧期号的开奖号码
- **等待后端WebSocket推送新期号** → 才更新倒计时
- 不基于API的countdown字段自动更新

## 修复效果

### ✅ 倒计时准确
- 与实际号码出现时间同步
- 新期号出现时倒计时从5分50秒（350秒）开始
- 稳定递减：350 → 300 → 250 → ... → 0

### ✅ 倒计时稳定
- 不会出现跳跃或异常值
- 倒计时≤0时返回0（不是350秒）
- 没有"倒计时≤0，重置为350秒"的警告

### ✅ 用户体验良好
- 倒计时归零 → 显示"开奖中"（等待20秒）
- 号码出现 → WebSocket推送 → 立即更新
- 新期号倒计时从5分50秒开始 → 稳定递减

## 技术细节

### 为什么是+50秒？
- 官方开奖流程需要20秒（用户实测）
- API更新延迟约30秒
- 总计约50秒延迟

### 为什么只针对台湾宾果（100007）？
```javascript
const drawDelaySeconds = (lotCode === '100007') ? 50 : 0;
```
- 其他彩种没有这个50秒延迟问题
- 只有台湾宾果需要特殊处理

### 为什么倒计时≤0时返回0？
- 当旧期号过期（过了下期实际完成时间）
- 但新期号还没检测到
- 此时应显示"开奖中"，等待WebSocket推送
- **不应该**显示350秒（会误导用户）

## 测试验证

### 正常流程
```
1. 期号115000938, dDate=17:30:00
   倒计时: 350秒 → 300秒 → ... → 10秒 → 0秒

2. 倒计时归零
   前端显示: "开奖中"
   后端继续: 每1秒轮询一次

3. 检测到新期号115000939
   后端: WebSocket推送新数据
   前端: 立即更新倒计时（350秒）
```

### 验证命令
```bash
# 查看Docker日志
docker logs --tail 100 lottery-crawler-compose 2>&1 | grep "台湾宾果"

# 验证倒计时
curl -s http://localhost:4000/api/status | python3 -c "
import sys,json
data=json.load(sys.stdin)
tw=[l for l in data['data']['scheduler']['lotteries'] if l['lotCode']=='100007'][0]
print(f'倒计时: {tw[\"countdown\"]}秒')
"
```

## 相关文件

### 修改的文件
1. `src/services/MultiSourceDataManager.js` (742-754行)
   - 给台湾宾果倒计时加50秒延迟
   - 倒计时≤0时返回0

### 前端文件（已有逻辑）
1. `src/web/vue-app/src/views/Realtime.vue`
   - 倒计时归零显示"开奖中"
   - 等待WebSocket推送新期号

### 配置文件
1. `data/official-sources.json`
   - `countdownBehavior: "wait_for_zero"` (快速轮询)

2. `data/lottery-configs.json`
   - 台湾宾果配置：`intervalSeconds: 300`

## 重启服务

### Docker容器方式
```bash
docker restart lottery-crawler-compose
```

### 验证修复
```bash
# 1. 检查是否有"倒计时≤0，重置为350秒"警告（应该没有）
docker logs --since "2m" lottery-crawler-compose 2>&1 | grep -c "倒计时≤0.*100007"
# 输出：0 ✓

# 2. 观察倒计时是否稳定递减
docker logs --tail 100 lottery-crawler-compose 2>&1 | grep "⏱️ 台湾宾果"
# 应该看到：350秒 → 300秒 → 250秒 ... 稳定递减 ✓
```

## 修复时间
- 2026-01-05 17:34
- Docker容器：lottery-crawler-compose
- 修复版本：Final（最终版）
