# 前端倒计时混合策略

## 策略说明

为了同时解决以下问题：
1. ✅ SG彩种等高频彩的服务器时间偏差问题（22秒earlyFetch偏差）
2. ✅ 福彩/体彩/台湾彩券等低频彩的复杂开奖规则

我们采用**混合策略**：

### 高频彩种（interval < 1小时）
**使用本地计算**

包括：
- 极速系列（75秒）：极速赛车、极速飞艇、极速时时彩、极速快3等
- SG彩种（300秒）：SG飞艇、SG时时彩、SG快3等
- AU彩种（300秒）：澳洲幸运5、澳洲幸运8等
- UK彩种（150秒）：英国乐透5、英国乐透8等
- 幸运系列（300秒）：幸运飞艇、幸运时时彩
- 极速六合彩（300秒）
- 台湾宾果（300秒）

**计算方式**：
```javascript
倒计时 = (drawTime + interval) - 当前浏览器时间
```

**优势**：
- 消除服务器与客户端时间差
- 页面刷新时倒计时立即准确
- 不依赖网络延迟

### 低频彩种（interval >= 1小时）
**同步后端倒计时**

包括：
- 福彩：双色球、3D、七乐彩、快乐8（每日开奖，时间不固定）
- 体彩：大乐透、排列3、排列5、七星彩（每日开奖）
- 台湾彩券：威力彩、大乐透、今彩539、3星彩、4星彩、39樂合彩、49樂合彩（每日或每周开奖）
- 香港六合彩（每周二、四、六开奖）

**计算方式**：
```javascript
倒计时 = 后端返回的 officialCountdown
```

**原因**：
这些彩种的开奖时间不规则，例如：
- 双色球：每周二、四、日 21:15开奖
- 香港六合彩：每周二、四、六开奖
- 威力彩：每周一、四开奖

后端有复杂的逻辑来计算下次开奖时间，前端无法简单用固定间隔计算。

## 实现代码

```javascript
// 判断是否为高频彩
const interval = getDrawInterval(lottery.lotCode)
const isHighFrequency = interval < 3600 // 小于1小时

if (isHighFrequency && data.drawTime) {
  // 高频彩：本地计算
  lottery.countdown = calculateCountdownFromDrawTime(data.drawTime, interval)
} else {
  // 低频彩：同步后端
  lottery.countdown = data.officialCountdown || 0
}
```

## 验证方法

重启服务后，打开浏览器控制台，查看日志：

### 高频彩示例
```
✅ [极速赛车] 高频彩本地计算: 45秒 (interval: 75秒)
✅ [SG飞艇] 高频彩本地计算: 245秒 (interval: 300秒)
✅ [澳洲幸运8] 高频彩本地计算: 180秒 (interval: 300秒)
```

### 低频彩示例
```
✅ [福彩双色球] 低频彩同步后端: 45610秒 (interval: 86400秒)
✅ [香港六合彩] 低频彩同步后端: 178310秒 (interval: 259200秒)
✅ [台湾威力彩] 低频彩同步后端: 91614秒 (interval: 86400秒)
```

## 重启命令

```bash
bash /tmp/restart-crawler-fixed.sh
```

或手动：
```bash
sudo kill -9 410144 && sleep 2 && cd /home/i8/claude-demo/kjqy-deploy/crawler-service && nohup sudo node src/index.js > /tmp/crawler-service.log 2>&1 &
```

## 预期效果

1. **SG彩种等高频彩**：刷新页面倒计时准确，无跳变
2. **福彩/体彩/台湾彩券**：保持与后端同步，显示准确的下次开奖倒计时
3. **所有彩种**：每秒平滑递减，无抖动

---
**更新时间**: 2026-01-13 20:10
**版本**: v2.0 混合策略
