# 极速彩倒计时归零后一直显示"开奖中"问题修复

## 问题描述

**现象**：极速彩（极速飞艇、极速赛车等）倒计时归零后，一直显示"开奖中"，即使 WebSocket 推送了新期号数据也不恢复。

**影响彩种**：所有 SpeedyLot88 极速彩种（lotCode: 10035, 10037, 10036 等）

---

## 根本原因

### 1. 前端问题（已修复）

**位置**：`src/web/vue-app/src/views/RealtimeElementPlus.vue:826`

**问题**：倒计时定时器只在 `countdown > 0` 时递减，归零后不再检测。

**修复**：添加了10秒强制刷新机制（见 `倒计时归零修复方案.md`）。

### 2. **后端问题（本次修复）** ⭐

**位置**：`src/web/WebServer.js:392-423` 和 `:608-637`

**问题分析**：

后端倒计时计算使用了错误的时间字段：

```javascript
// ❌ 错误代码（修复前）
} else if (data.created_at) {
  // 使用数据库插入时间（检测时间），而不是实际开奖时间！
  const lastDrawTime = new Date(data.created_at).getTime() / 1000;
  const elapsed = currentTime - lastDrawTime;
  const calculatedCountdown = Math.max(0, 75 - elapsed);
  data.officialCountdown = calculatedCountdown;
}
```

**时间线对比**：

```
极速彩一期流程：
T0: 爬虫检测到新期号，数据库插入 created_at = T0
T1: 实际开奖时间 draw_time = T0 + 60秒（例如）
T2: 下一期开奖时间 = T1 + 75秒 = T0 + 135秒

当前倒计时归零后（T0 + 75秒）：
elapsed = now - T0 = 75秒
countdown = Math.max(0, 75 - 75) = 0  ❌ 一直是0！

正确计算（使用 draw_time）：
elapsed = now - (T0 + 60) = 15秒
countdown = Math.max(0, 75 - 15) = 60秒  ✅ 正确！
```

**数据库字段对比**：

| 字段 | 含义 | 是否准确 |
|------|------|----------|
| `created_at` | 数据插入时间（检测时间） | ❌ 不准确（可能提前很多） |
| `draw_time` | 实际开奖时间（爬虫解析） | ✅ 准确（官方数据） |
| `unixtime` | Unix时间戳（SG彩种专用） | ✅ 准确（SG彩种有） |

**SpeedyLot88 爬虫返回的字段**：

```javascript
// src/scrapers/SpeedyLot88Scraper.js:240
return {
  lotCode,
  period,
  numbers,
  opencode,
  drawTime,  // ✅ 实际开奖时间（官方数据）
  officialCountdown,
  timestamp,
  source: 'speedylot88_html'
};
```

---

## 修复方案

###添加 `draw_time` 字段检查优先级

**修改文件**：`src/web/WebServer.js`

#### 修改1：单个彩种 API（行392-423）

```javascript
// ✅ 修复后代码
} else if (data.draw_time) {
  // Fallback1: 使用数据库中的draw_time字段（SpeedyLot88彩种的实际开奖时间）
  const lastDrawTime = new Date(data.draw_time).getTime() / 1000;
  const elapsed = currentTime - lastDrawTime;
  const calculatedCountdown = Math.max(0, drawInterval - elapsed);
  data.officialCountdown = earlyFetch > 0
    ? Math.round(calculatedCountdown) + earlyFetch
    : Math.round(calculatedCountdown);

  logger.debug(
    `[API] ${lotCode} 倒计时: ${data.officialCountdown}秒 (基于draw_time计算)`
  );
} else if (data.created_at) {
  // Fallback2: 使用数据库中的检测时间（仅当draw_time不存在时）
  // ...
}
```

#### 修改2：批量彩种 API（行608-637）

```javascript
// ✅ 修复后代码
} else if (row.drawTime) {
  // Fallback1: 使用数据库中的drawTime字段（SpeedyLot88彩种的实际开奖时间）
  const lastDrawTime = new Date(row.drawTime).getTime() / 1000;
  const elapsed = currentTime - lastDrawTime;
  const calculatedCountdown = Math.max(0, drawInterval - elapsed);
  row.officialCountdown = earlyFetch > 0
    ? Math.round(calculatedCountdown) + earlyFetch
    : Math.round(calculatedCountdown);
} else if (row.createdAt) {
  // Fallback2: 使用数据库中的检测时间
  // ...
}
```

**优先级顺序**：
1. 调度器精确时间戳（`lastDrawTimestamp`）- 毫秒级
2. **`draw_time` 字段**（SpeedyLot88 实际开奖时间）- ⭐ 本次新增
3. `created_at` 字段（数据库插入时间）- Fallback

---

## 修复效果

### Before（修复前）

```
倒计时: 75 → 74 → ... → 1 → 0
显示"开奖中"
前端2秒后刷新
后端返回: officialCountdown = 0 (基于created_at)
❌ 永久卡在"开奖中"
前端10秒强制刷新
后端返回: officialCountdown = 0 (仍然是0)
❌ 继续卡在"开奖中"
```

### After（修复后）

```
倒计时: 75 → 74 → ... → 1 → 0
显示"开奖中"
前端2秒后刷新
后端返回: officialCountdown = 60 (基于draw_time)
✅ 倒计时恢复为60秒
继续正常倒计时
```

---

## 测试验证

### 测试步骤

1. 访问 http://localhost:4000/realtime
2. 观察极速彩倒计时
3. 等待倒计时归零
4. 观察前端控制台日志
5. 验证倒计时是否恢复

### 预期日志

**前端日志**：
```
⏰ 极速飞艇 倒计时归零，2秒后自动刷新
⏱️ 极速飞艇 倒计时归零，开始计时
✅ [极速飞艇] 其他彩种手动刷新倒计时: 60秒  ← ✅ 不再是0秒
🔄 [极速飞艇] 倒计时恢复为60秒，清除归零标记
```

**后端日志**：
```
[API] 10035 倒计时: 60秒 (基于draw_time计算)
```

---

## 相关文件

- **后端倒计时计算**：`src/web/WebServer.js:392-423, 608-637`
- **前端倒计时逻辑**：`src/web/vue-app/src/views/RealtimeElementPlus.vue`
- **SpeedyLot88 爬虫**：`src/scrapers/SpeedyLot88Scraper.js:240`
- **前端修复方案**：`倒计时归零修复方案.md`

---

## 注意事项

1. **双重保险**：前端10秒强制刷新 + 后端使用正确时间字段
2. **SG彩种不受影响**：SG彩种使用 `unixtime` 字段，优先级更高
3. **调度器时间戳优先**：如果调度器有精确时间戳，优先使用
4. **向后兼容**：`created_at` 作为最后的 Fallback，确保兼容性

---

**修复时间**：2026-01-14
**修复版本**：v1.0.2
**问题追踪**：#极速彩倒计时归零问题
