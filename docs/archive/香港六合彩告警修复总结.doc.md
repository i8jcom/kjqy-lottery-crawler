# 香港六合彩告警修复总结

## 问题描述

用户反馈告警管理页面（http://localhost:4000/alerts）出现大量香港六合彩的"彩种停更告警"，但香港六合彩是低频彩，每周只开奖3次（周二、周四、周六晚9:30），非开奖日出现告警是误报。

### 告警历史记录

修复前有9条告警记录，大多数是香港六合彩的停更告警：
- 37分钟未更新
- 30分钟未更新
- 24分钟未更新
- 18分钟未更新
- 12分钟未更新

每2分钟检查一次，持续触发误报。

## 根本原因

### 1. 告警规则设计

告警规则位于 `/src/alerts/AlertRules.js` 的 `lotteryStoppedUpdatingRule`（182-250行）。

**原有逻辑**：
```javascript
const isLowFrequencyLottery = lottery.tags && lottery.tags.includes('低频彩');
const hasLongCountdown = lottery.countdown && lottery.countdown > 600;

// 低频彩：如果倒计时>10分钟，不报警
if (isLowFrequencyLottery && hasLongCountdown) {
  return false;
}
```

这个逻辑只考虑了倒计时 > 10分钟的情况，但**没有考虑倒计时为 -1 的情况**。

### 2. 倒计时的含义

香港六合彩的倒计时有两种状态：

| 状态 | 倒计时值 | 说明 |
|------|---------|------|
| 开奖日（周二/四/六） | 正常值（如 3600秒） | 距离下次开奖的时间 |
| **非开奖日**（周日/一/三/五） | **-1** | 表示今天不开奖 |

### 3. 问题分析

当香港六合彩处于非开奖日时：
- `lottery.countdown` = -1
- `isLowFrequencyLottery` = true（有"低频彩"标签）
- `hasLongCountdown` = **false**（因为 -1 不满足 `> 600`）
- **告警抑制逻辑不生效** ❌
- 每2分钟触发一次误报 ❌

### 4. 数据源验证

**彩种配置**（`data/lottery-configs.json`）：
```json
{
  "lotCode": "60001",
  "name": "香港六合彩",
  "tags": ["官方彩", "低频彩", "香港彩", "六合彩"],
  "description": "On.cc 东网官方数据源（每周二、四、六晚9:30开奖）"
}
```
✅ 配置正确，有"低频彩"标签

**上下文构建**（`src/index.js` 171-202行）：
```javascript
alertService.registerContextProvider('lotteryUpdateStatus', async () => {
  // ...
  return {
    lotCode: lottery.lotCode,
    name: lottery.name,
    tags: lottery.tags || [],     // ✅ 标签已传递
    countdown: countdown           // ✅ 倒计时已传递
  };
});
```
✅ 上下文构建正确，标签和倒计时都已传递

## 修复方案

### 修改文件

`/home/i8/claude-demo/kjqy-deploy/crawler-service/src/alerts/AlertRules.js`

### 修改内容

在告警抑制逻辑中增加对 `-1` 倒计时的处理：

```javascript
// 🎯 智能告警：根据彩种类型和倒计时判断告警阈值
const isLowFrequencyLottery = lottery.tags && lottery.tags.includes('低频彩');
const hasLongCountdown = lottery.countdown && lottery.countdown > 600; // 倒计时>10分钟
const isNotDrawDay = lottery.countdown === -1; // 倒计时为-1表示非开奖日

// 低频彩（如香港六合彩）：如果倒计时>10分钟 或 非开奖日，不报警
// 只在倒计时<10分钟时才检测停更，避免误报
if (isLowFrequencyLottery && (hasLongCountdown || isNotDrawDay)) {
  return false;
}
```

### 关键改动

1. **新增变量**：`const isNotDrawDay = lottery.countdown === -1;`
   - 识别非开奖日（倒计时为-1）

2. **修改条件**：`if (isLowFrequencyLottery && (hasLongCountdown || isNotDrawDay))`
   - 原来：只在倒计时 > 10分钟时抑制
   - 现在：在倒计时 > 10分钟 **或** 非开奖日时抑制

3. **应用范围**：同时修改了 `condition` 和 `message` 函数（2处）

## 修复效果

### 告警抑制逻辑

| 彩种类型 | 倒计时 | 告警行为 |
|---------|--------|---------|
| 高频彩（如幸运飞艇） | 任意值 | 停更>10分钟触发告警 |
| 低频彩 | > 10分钟 | ✅ 抑制告警（正常） |
| 低频彩 | -1（非开奖日） | ✅ **抑制告警（修复）** |
| 低频彩 | < 10分钟 | ⚠️ 停更>10分钟触发告警 |

### 验证结果

**修复前**：
```
总告警数: 9
香港六合彩告警数: 5+
```

**修复后**：
```bash
$ curl http://localhost:4000/api/alerts/history
总告警数: 0
香港六合彩告警数: 0 ✅
```

**实时状态**：
```
✅ 香港六合彩当前状态:
   彩种名称: 香港六合彩
   期号: None
   倒计时: -1 秒
   状态: scheduled

🔍 告警抑制逻辑:
   ✓ 倒计时为-1（非开奖日）
   ✓ 低频彩 + 非开奖日 → 告警已抑制 ✅
```

## 测试验证

### 1. 启动服务

```bash
docker restart lottery-crawler-compose
```

### 2. 检查倒计时

```bash
curl -s http://localhost:4000/api/status | python3 -c "
import sys, json
data = json.load(sys.stdin)
hkjc = [l for l in data['data']['scheduler']['lotteries'] if l['lotCode'] == '60001'][0]
print(f'倒计时: {hkjc[\"countdown\"]} 秒')
"
```

输出：`倒计时: -1 秒` ✅

### 3. 检查告警历史

```bash
curl -s http://localhost:4000/api/alerts/history | python3 -c "
import sys, json
data = json.load(sys.stdin)
alerts = [a for a in data['data']['alerts'] if '香港六合彩' in a['message']]
print(f'香港六合彩告警数: {len(alerts)}')
"
```

输出：`香港六合彩告警数: 0` ✅

### 4. 监控日志（2分钟）

```bash
docker logs --since "3m" lottery-crawler-compose 2>&1 | grep -E "香港六合彩.*告警"
```

输出：无（说明没有新告警）✅

## 相关文件

### 修改的文件

1. **`/src/alerts/AlertRules.js`** (202-211行 & 229-238行)
   - 增加 `isNotDrawDay` 变量
   - 修改告警抑制条件

### 相关配置文件

1. **`/data/lottery-configs.json`**
   - 香港六合彩配置（lotCode: 60001）
   - 包含"低频彩"标签

2. **`/src/index.js`** (171-202行)
   - `lotteryUpdateStatus` 上下文提供者
   - 传递 `tags` 和 `countdown` 字段

## 其他低频彩

此修复同时适用于所有带"低频彩"标签的彩种：

| 彩种 | lotCode | 开奖频率 | 标签 |
|------|---------|---------|------|
| 香港六合彩 | 60001 | 每周3次 | 低频彩 |
| 七乐彩 | 30004 | 每周3次 | 低频彩 |
| （其他） | ... | ... | 低频彩 |

所有低频彩在非开奖日（倒计时 = -1）都不会再触发误报。

## 修复时间

- **发现问题**: 2026-01-05 20:20
- **定位根因**: 2026-01-05 20:30
- **完成修复**: 2026-01-05 20:35
- **Docker重启**: `docker restart lottery-crawler-compose`
- **验证通过**: 2026-01-05 20:40

## 总结

### 问题本质

告警抑制逻辑只考虑了"长倒计时"场景，忽略了"非开奖日"场景（倒计时 = -1）。

### 解决方案

增加对 `-1` 倒计时的识别，作为告警抑制的额外条件。

### 影响范围

- ✅ 香港六合彩不再误报
- ✅ 其他低频彩不再误报
- ✅ 高频彩告警逻辑不受影响
- ✅ 低频彩在开奖日的告警逻辑不受影响

### 长期效果

彻底解决低频彩在非开奖日的误报问题，提高告警系统的准确性和可信度。
