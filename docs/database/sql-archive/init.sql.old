-- 彩票爬虫系统数据库初始化脚本
-- 创建时间: 2025-12-22

-- 设置字符集
SET NAMES utf8mb4;
SET CHARACTER SET utf8mb4;

-- 使用数据库
USE lottery_crawler;

-- 彩票开奖结果表
CREATE TABLE IF NOT EXISTS lottery_results (
  id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
  lot_code VARCHAR(50) NOT NULL COMMENT '彩种代码',
  issue VARCHAR(50) NOT NULL COMMENT '期号',
  draw_code VARCHAR(500) NOT NULL COMMENT '开奖号码',
  draw_time DATETIME NOT NULL COMMENT '开奖时间',
  unixtime INT NULL COMMENT 'Unix时间戳(秒) - AU彩种特有，用于精确计算倒计时',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  UNIQUE KEY uk_lot_issue (lot_code, issue),
  KEY idx_lot_code (lot_code),
  KEY idx_draw_time (draw_time),
  KEY idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='彩票开奖结果表';

-- 爬虫任务日志表
CREATE TABLE IF NOT EXISTS crawler_logs (
  id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
  lot_code VARCHAR(50) NOT NULL COMMENT '彩种代码',
  task_type VARCHAR(50) NOT NULL COMMENT '任务类型: realtime/history',
  status VARCHAR(20) NOT NULL COMMENT '状态: success/failed',
  source VARCHAR(100) COMMENT '数据源',
  error_message TEXT COMMENT '错误信息',
  records_count INT DEFAULT 0 COMMENT '采集记录数',
  start_time DATETIME NOT NULL COMMENT '开始时间',
  end_time DATETIME COMMENT '结束时间',
  duration INT COMMENT '耗时(毫秒)',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  KEY idx_lot_code (lot_code),
  KEY idx_status (status),
  KEY idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='爬虫任务日志表';

-- 初始化完成标记
INSERT INTO lottery_results (lot_code, issue, draw_code, draw_time)
VALUES ('SYSTEM', 'INIT', 'Database initialized', NOW())
ON DUPLICATE KEY UPDATE draw_code = 'Database initialized';
