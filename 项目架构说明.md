# å½©ç¥¨çˆ¬è™«ç³»ç»Ÿ - é¡¹ç›®æ¶æ„è¯´æ˜

## ğŸ“‹ ç›®å½•

- [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
- [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
- [æ ¸å¿ƒæ¶æ„](#æ ¸å¿ƒæ¶æ„)
- [æ¨¡å—è¯´æ˜](#æ¨¡å—è¯´æ˜)
- [æ•°æ®æµè½¬](#æ•°æ®æµè½¬)
- [å…³é”®è®¾è®¡](#å…³é”®è®¾è®¡)

---

## ç³»ç»Ÿæ¦‚è¿°

### è®¾è®¡ç›®æ ‡

- **é«˜å¯ç”¨æ€§**: 95-98% ç³»ç»Ÿå¯ç”¨ç‡ï¼Œæ”¯æŒè‡ªåŠ¨æ•…éšœè½¬ç§»
- **å¤šæ•°æ®æº**: æ”¯æŒ15ä¸ªçˆ¬è™«å®ç°ï¼Œè‡ªåŠ¨åˆ‡æ¢å’Œè´Ÿè½½å‡è¡¡
- **å®æ—¶ç›‘æ§**: WebSocketå®æ—¶æ¨é€ï¼Œå‘Šè­¦ç³»ç»Ÿè‡ªåŠ¨é€šçŸ¥
- **æ•°æ®å®Œæ•´æ€§**: è‡ªåŠ¨è¡¥å…¨æœºåˆ¶ï¼Œç¡®ä¿å†å²æ•°æ®å®Œæ•´
- **æ˜“äºæ‰©å±•**: æ¨¡å—åŒ–è®¾è®¡ï¼Œæ”¯æŒå¿«é€Ÿæ·»åŠ æ–°å½©ç§å’Œæ•°æ®æº

### ç³»ç»Ÿèƒ½åŠ›

- **æ”¯æŒå½©ç§**: 30+ å½©ç§ï¼ˆä¸­å›½ç¦å½©ã€ä½“å½©ã€é¦™æ¸¯å…­åˆå½©ã€æ–°åŠ å¡å½©ã€æ¾³æ´²å½©ã€å°æ¹¾å½©ç¥¨ç­‰ï¼‰
- **æ•°æ®æº**: 15ä¸ªçˆ¬è™«å®ç°ï¼Œè¦†ç›–å®˜æ–¹æºå’Œç¬¬ä¸‰æ–¹æ•°æ®æº
- **çˆ¬å–é¢‘ç‡**: é«˜é¢‘å½©75ç§’/æ¬¡ï¼Œä½é¢‘å½©5åˆ†é’Ÿ/æ¬¡
- **å¹¶å‘å¤„ç†**: æ”¯æŒå¤šå½©ç§å¹¶å‘çˆ¬å–
- **æ•°æ®å­˜å‚¨**: å·²å­˜å‚¨550,000+ å¼€å¥–è®°å½•
- **APIæ¥å£**: 89ä¸ªREST APIæ¥å£ï¼Œæ¶µç›–æ•°æ®æŸ¥è¯¢ã€ç³»ç»Ÿç®¡ç†ã€ç›‘æ§å‘Šè­¦
- **å‰ç«¯é¡µé¢**: 15ä¸ªVueé¡µé¢ç»„ä»¶ï¼Œ100%ä½¿ç”¨Element Plus UIæ¡†æ¶
- **å‘Šè­¦å“åº”**: å®æ—¶å‘Šè­¦ï¼Œæ”¯æŒé‚®ä»¶ã€é’‰é’‰ã€Webhooké€šçŸ¥

---

## æŠ€æœ¯æ ˆ

### åç«¯æŠ€æœ¯

```javascript
{
  "runtime": "Node.js 18+",
  "framework": "Express.js",
  "database": "MySQL 8.0",
  "orm": "mysql2 (åŸç”ŸSQL)",
  "scheduler": "node-cron",
  "crawler": "puppeteer + axios",
  "websocket": "ws",
  "logger": "winston",
  "container": "Docker + Docker Compose"
}
```

### å‰ç«¯æŠ€æœ¯

```javascript
{
  "framework": "Vue 3",
  "ui": "Element Plus",
  "buildTool": "Vite",
  "router": "Vue Router 4",
  "http": "axios",
  "websocket": "åŸç”ŸWebSocket",
  "pages": "15ä¸ªé¡µé¢ç»„ä»¶ï¼ˆ100% Element Plusï¼‰",
  "components": "25ä¸ªé€šç”¨ç»„ä»¶"
}
```

**å‰ç«¯é¡µé¢è¯¦è§£** (15ä¸ªé¡µé¢ï¼Œ100% Element Plus):

**æ ¸å¿ƒåŠŸèƒ½é¡µé¢** (4ä¸ª):
- `DashboardElementPlus.vue` - ç³»ç»Ÿä»ªè¡¨ç›˜ï¼ˆå½©ç§æ€»è§ˆã€ä»Šæ—¥ç»Ÿè®¡ï¼‰
- `RealtimeElementPlus.vue` - å®æ—¶å¼€å¥–æ•°æ®ï¼ˆWebSocketæ¨é€ã€å€’è®¡æ—¶ï¼‰
- `HistoryElementPlus.vue` - å†å²æ•°æ®æŸ¥è¯¢ï¼ˆæ—¥æœŸç­›é€‰ã€åˆ†é¡µã€å¯¼å‡ºï¼‰
- `DataCompletionElementPlus.vue` - æ•°æ®è¡¥å…¨å·¥å…·ï¼ˆç¼ºå¤±æ£€æµ‹ã€è‡ªåŠ¨å›å¡«ï¼‰

**ç³»ç»Ÿç®¡ç†é¡µé¢** (7ä¸ª):
- `SourcesElementPlus.vue` - æ•°æ®æºç®¡ç†ï¼ˆå¯ç”¨/ç¦ç”¨ã€ä¼˜å…ˆçº§ï¼‰
- `DomainManagementElementPlus.vue` - åŸŸåå¥åº·ç®¡ç†ï¼ˆå¥åº·æ£€æŸ¥ã€åˆ‡æ¢å†å²ï¼‰
- `LotteryConfigsElementPlus.vue` - å½©ç§é…ç½®ç®¡ç†
- `SchedulerElementPlus.vue` - è°ƒåº¦å™¨çŠ¶æ€ç›‘æ§
- `DataManagementElementPlus.vue` - æ•°æ®ç®¡ç†å·¥å…·ï¼ˆæ¸…ç†ã€ä¼˜åŒ–ï¼‰
- `SettingsElementPlus.vue` - ç³»ç»Ÿè®¾ç½®
- `SystemMonitorElementPlus.vue` - ç³»ç»Ÿç›‘æ§ï¼ˆCPUã€å†…å­˜ã€ç½‘ç»œï¼‰

**å‘Šè­¦ä¸æ—¥å¿—** (3ä¸ª):
- `AlertsLuxuryElementPlus.vue` - å‘Šè­¦å†å²å’Œè§„åˆ™ç®¡ç†
- `LogsProElementPlus.vue` - çˆ¬è™«æ—¥å¿—æŸ¥çœ‹ï¼ˆçº§åˆ«ç­›é€‰ã€æœç´¢ï¼‰
- `WebSocketMonitorElementPlus.vue` - WebSocketè¿æ¥ç›‘æ§

**æµ‹è¯•ä¸ä¸»é¢˜** (1ä¸ª):
- `ElementThemeTest.vue` - Element Plusä¸»é¢˜æµ‹è¯•é¡µé¢

**UIä¸€è‡´æ€§**:
- 100%ä½¿ç”¨Element Plusç»„ä»¶åº“
- ç»Ÿä¸€çš„æ·±è‰²ä¸»é¢˜è®¾è®¡
- ç»Ÿä¸€çš„ç”¨æˆ·äº¤äº’ä½“éªŒ
- æ‰€æœ‰é¡µé¢æ”¯æŒæ‡’åŠ è½½

### åŸºç¡€è®¾æ–½

- **å®¹å™¨åŒ–**: Docker + Docker Compose
- **æ•°æ®åº“**: MySQL 8.0ï¼ˆæ”¯æŒJSONå­—æ®µã€è§†å›¾ã€å¤–é”®ï¼‰
- **åå‘ä»£ç†**: å¯é€‰ Nginxï¼ˆHTTPSã€è´Ÿè½½å‡è¡¡ï¼‰
- **è¿›ç¨‹ç®¡ç†**: Docker restartç­–ç•¥ æˆ– PM2

---

## æ ¸å¿ƒæ¶æ„

### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç”¨æˆ·æµè§ˆå™¨                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  å®æ—¶å½©ç§    â”‚  â”‚  å†å²æ•°æ®    â”‚  â”‚  ç³»ç»Ÿç›‘æ§    â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚ HTTP/WS          â”‚ HTTP             â”‚ HTTP
          â–¼                  â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    WebæœåŠ¡å™¨ (Express.js)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  é™æ€æ–‡ä»¶    â”‚  â”‚  REST API    â”‚  â”‚  WebSocket   â”‚      â”‚
â”‚  â”‚   æœåŠ¡å™¨     â”‚  â”‚   æ¥å£       â”‚  â”‚   æ¨é€       â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                  â”‚                  â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      çˆ¬è™«è°ƒåº¦å™¨                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  CrawlerScheduler (å®šæ—¶ä»»åŠ¡è°ƒåº¦)                  â”‚       â”‚
â”‚  â”‚  - é«˜é¢‘å½©: 75ç§’/æ¬¡                                â”‚       â”‚
â”‚  â”‚  - ä½é¢‘å½©: 5åˆ†é’Ÿ/æ¬¡                               â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼        â–¼        â–¼        â–¼        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CWL     â”‚ â”‚Speedy   â”‚ â”‚SG       â”‚ â”‚AU       â”‚ â”‚ HKJC    â”‚
â”‚ Scraper â”‚ â”‚Scraper  â”‚ â”‚Scraper  â”‚ â”‚Scraper  â”‚ â”‚ Scraper â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚           â”‚           â”‚           â”‚           â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ï¿½ï¿½â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   åŸŸåç®¡ç†å™¨ (DomainManager)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  - å¤šåŸŸåæ± ç®¡ç†                                    â”‚       â”‚
â”‚  â”‚  - å¥åº·æ£€æŸ¥ï¼ˆæ¯åˆ†é’Ÿï¼‰                              â”‚       â”‚
â”‚  â”‚  - è‡ªåŠ¨æ•…éšœè½¬ç§»                                    â”‚       â”‚
â”‚  â”‚  - ä¼˜å…ˆçº§è°ƒåº¦                                      â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        MySQL æ•°æ®åº“                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚lottery_      â”‚  â”‚alert_        â”‚  â”‚cwl_api_      â”‚      â”‚
â”‚  â”‚results       â”‚  â”‚rules/history â”‚  â”‚domains       â”‚      â”‚
â”‚  â”‚(550K+ æ¡)    â”‚  â”‚(å‘Šè­¦ç³»ç»Ÿ)    â”‚  â”‚(åŸŸåç®¡ç†)    â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç›®å½•ç»“æ„

```
crawler-service/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.js                    # ä¸»å…¥å£ï¼ˆå¯åŠ¨çˆ¬è™«+WebæœåŠ¡å™¨ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ alerts/                     # å‘Šè­¦ç³»ç»Ÿ
â”‚   â”‚   â”œâ”€â”€ AlertManager.js         # å‘Šè­¦ç®¡ç†å™¨ï¼ˆè§„åˆ™å¼•æ“ï¼‰
â”‚   â”‚   â””â”€â”€ NotificationManager.js  # é€šçŸ¥å‘é€å™¨ï¼ˆé‚®ä»¶/é’‰é’‰/Webhookï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ config/                     # é…ç½®æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ crawlerConfig.js        # çˆ¬è™«é…ç½®ï¼ˆå½©ç§å®šä¹‰ã€è½®è¯¢é—´éš”ï¼‰
â”‚   â”‚   â””â”€â”€ dbConfig.js             # æ•°æ®åº“é…ç½®
â”‚   â”‚
â”‚   â”œâ”€â”€ db/                         # æ•°æ®åº“å±‚
â”‚   â”‚   â””â”€â”€ Database.js             # MySQLè¿æ¥æ± ã€æŸ¥è¯¢å°è£…
â”‚   â”‚
â”‚   â”œâ”€â”€ domains/                    # åŸŸåç®¡ç†
â”‚   â”‚   â”œâ”€â”€ DomainManager.js        # å•æ•°æ®æºåŸŸåç®¡ç†å™¨
â”‚   â”‚   â””â”€â”€ UniversalDomainManager.js # é€šç”¨åŸŸåç®¡ç†å™¨
â”‚   â”‚
â”‚   â”œâ”€â”€ scrapers/                   # çˆ¬è™«å®ç° (15ä¸ª)
â”‚   â”‚   â”œâ”€â”€ CWLFreeScraper.js          # ä¸­å›½ç¦å½©ï¼ˆå…è´¹æºï¼‰
â”‚   â”‚   â”œâ”€â”€ SportsLotteryScraper.js    # ä¸­å›½ä½“å½©
â”‚   â”‚   â”œâ”€â”€ HKJCScraper.js             # é¦™æ¸¯å…­åˆå½©ï¼ˆèµ›é©¬ä¼šå®˜æ–¹ï¼‰
â”‚   â”‚   â”œâ”€â”€ Taiwan39M5Scraper.js       # å°æ¹¾ä»Šå½©539
â”‚   â”‚   â”œâ”€â”€ Taiwan49M6Scraper.js       # å°æ¹¾å¤§ä¹é€
â”‚   â”‚   â”œâ”€â”€ TaiwanBingoScraper.js      # å°æ¹¾å®¾æœ
â”‚   â”‚   â”œâ”€â”€ TaiwanLotteryScraper.js    # å°æ¹¾å½©ç¥¨é€šç”¨
â”‚   â”‚   â”œâ”€â”€ SGLotteriesScraper.js      # æ–°åŠ å¡å½©
â”‚   â”‚   â”œâ”€â”€ AULuckyLotteriesScraper.js # æ¾³æ´²å½©
â”‚   â”‚   â”œâ”€â”€ UKLottosScraper.js         # è‹±å›½å½©ç¥¨
â”‚   â”‚   â”œâ”€â”€ SpeedyLot88Scraper.js      # æé€Ÿå½©88
â”‚   â”‚   â”œâ”€â”€ LuckySscaiScraper.js       # å¹¸è¿æ—¶æ—¶å½©
â”‚   â”‚   â”œâ”€â”€ LuckyLottozScraper.js      # å¹¸è¿é£è‰‡
â”‚   â”‚   â”œâ”€â”€ CPZhanHistoryScraper.js    # CPZhanå†å²æ•°æ®
â”‚   â”‚   â””â”€â”€ OnccHistoryScraper.js      # ONCCå†å²æ•°æ®
â”‚   â”‚
â”‚   â”œâ”€â”€ schedulers/                 # è°ƒåº¦å™¨
â”‚   â”‚   â””â”€â”€ CrawlerScheduler.js     # å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨
â”‚   â”‚
â”‚   â”œâ”€â”€ utils/                      # å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ logger.js               # æ—¥å¿—å·¥å…·ï¼ˆwinstonï¼‰
â”‚   â”‚   â”œâ”€â”€ snowballRecognizer.js   # é‡‘å¤šå®è¯†åˆ«å™¨
â”‚   â”‚   â””â”€â”€ validators.js           # æ•°æ®éªŒè¯å·¥å…·
â”‚   â”‚
â”‚   â””â”€â”€ web/                        # WebæœåŠ¡
â”‚       â”œâ”€â”€ WebServer.js            # ExpressæœåŠ¡å™¨ï¼ˆAPI + é™æ€æ–‡ä»¶ï¼‰
â”‚       â”œâ”€â”€ WebSocketManager.js     # WebSocketç®¡ç†å™¨
â”‚       â”œâ”€â”€ dist/                   # å‰ç«¯æ„å»ºäº§ç‰©ï¼ˆç”Ÿäº§ç¯å¢ƒä½¿ç”¨ï¼‰
â”‚       â””â”€â”€ vue-app/                # Vue 3å‰ç«¯é¡¹ç›®
â”‚           â”œâ”€â”€ src/
â”‚           â”‚   â”œâ”€â”€ views/          # é¡µé¢ç»„ä»¶
â”‚           â”‚   â”œâ”€â”€ components/     # é€šç”¨ç»„ä»¶
â”‚           â”‚   â”œâ”€â”€ services/       # APIæœåŠ¡
â”‚           â”‚   â””â”€â”€ router/         # è·¯ç”±é…ç½®
â”‚           â”œâ”€â”€ vite.config.js
â”‚           â””â”€â”€ package.json
â”‚
â”œâ”€â”€ scripts/                        # è„šæœ¬å·¥å…·
â”‚   â”œâ”€â”€ rebuild-and-restart.sh      # é‡å»ºå‰ç«¯å¹¶é‡å¯
â”‚   â”œâ”€â”€ migrations/                 # æ•°æ®åº“è¿ç§»è„šæœ¬
â”‚   â”œâ”€â”€ verification/               # éªŒè¯è„šæœ¬
â”‚   â””â”€â”€ tests/                      # æµ‹è¯•è„šæœ¬
â”‚
â”œâ”€â”€ docs/                           # æ–‡æ¡£
â”‚   â”œâ”€â”€ database/                   # æ•°æ®åº“ç›¸å…³æ–‡æ¡£
â”‚   â”œâ”€â”€ fixes/                      # é—®é¢˜ä¿®å¤è®°å½•
â”‚   â””â”€â”€ maintenance/                # ç»´æŠ¤å†å²è®°å½•
â”‚
â”œâ”€â”€ logs/                           # æ—¥å¿—æ–‡ä»¶ï¼ˆgitignoreï¼‰
â”œâ”€â”€ data/                           # æ•°æ®æ–‡ä»¶
â”‚
â”œâ”€â”€ docker-compose.yml              # Docker Composeé…ç½®
â”œâ”€â”€ Dockerfile                      # çˆ¬è™«æœåŠ¡é•œåƒ
â”œâ”€â”€ init.sql                        # æ•°æ®åº“åˆå§‹åŒ–ï¼ˆ10ä¸ªè¡¨ï¼‰
â”œâ”€â”€ package.json                    # Node.jsä¾èµ–
â””â”€â”€ README.md                       # é¡¹ç›®è¯´æ˜
```

---

## æ¨¡å—è¯´æ˜

### 1. çˆ¬è™«è°ƒåº¦å™¨ (CrawlerScheduler)

**èŒè´£**: ç®¡ç†æ‰€æœ‰å½©ç§çš„å®šæ—¶çˆ¬å–ä»»åŠ¡

**æ ¸å¿ƒåŠŸèƒ½**:
- é«˜é¢‘å½©è°ƒåº¦ï¼ˆ75ç§’è½®è¯¢ï¼‰
- ä½é¢‘å½©è°ƒåº¦ï¼ˆ5åˆ†é’Ÿè½®è¯¢ï¼‰
- ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†ï¼ˆé¿å…å¹¶å‘å†²çªï¼‰
- é”™è¯¯é‡è¯•æœºåˆ¶
- çˆ¬å–æ—¥å¿—è®°å½•

**å…³é”®ä»£ç ** (`src/schedulers/CrawlerScheduler.js`):
```javascript
class CrawlerScheduler {
  constructor() {
    this.scrapers = new Map();        // å½©ç§çˆ¬è™«æ˜ å°„
    this.runningTasks = new Set();    // æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡
  }

  // å¯åŠ¨æ‰€æœ‰è°ƒåº¦ä»»åŠ¡
  start() {
    // é«˜é¢‘å½©ï¼š75ç§’è½®è¯¢
    cron.schedule('*/75 * * * * *', () => {
      this.scheduleHighFrequency();
    });

    // ä½é¢‘å½©ï¼š5åˆ†é’Ÿè½®è¯¢
    cron.schedule('*/5 * * * *', () => {
      this.scheduleLowFrequency();
    });
  }

  // æ‰§è¡Œçˆ¬å–ä»»åŠ¡
  async executeCrawl(lotCode) {
    if (this.runningTasks.has(lotCode)) {
      return; // é¿å…é‡å¤æ‰§è¡Œ
    }

    this.runningTasks.add(lotCode);
    try {
      const scraper = this.scrapers.get(lotCode);
      await scraper.crawl();
    } finally {
      this.runningTasks.delete(lotCode);
    }
  }
}
```

### 2. çˆ¬è™«åŸºç±» (BaseScraper)

**èŒè´£**: æä¾›çˆ¬è™«é€šç”¨åŠŸèƒ½ï¼Œå­ç±»ç»§æ‰¿å®ç°å…·ä½“æ•°æ®æº

**æ ¸å¿ƒåŠŸèƒ½**:
- HTTPè¯·æ±‚å°è£…ï¼ˆè¶…æ—¶ã€é‡è¯•ï¼‰
- åŸŸåç®¡ç†é›†æˆ
- æ•°æ®éªŒè¯
- é”™è¯¯å¤„ç†
- æ—¥å¿—è®°å½•

**å…³é”®ä»£ç ** (`src/scrapers/BaseScraper.js`):
```javascript
class BaseScraper {
  constructor(lotCode, domainManager) {
    this.lotCode = lotCode;
    this.domainManager = domainManager;
  }

  // æŠ½è±¡æ–¹æ³•ï¼Œå­ç±»å¿…é¡»å®ç°
  async fetchData() {
    throw new Error('fetchData() must be implemented');
  }

  // é€šç”¨çˆ¬å–æµç¨‹
  async crawl() {
    const startTime = Date.now();
    try {
      // 1. è·å–æ•°æ®
      const data = await this.fetchData();

      // 2. éªŒè¯æ•°æ®
      if (!this.validateData(data)) {
        throw new Error('Data validation failed');
      }

      // 3. ä¿å­˜åˆ°æ•°æ®åº“
      await this.saveToDatabase(data);

      // 4. è®°å½•æ—¥å¿—
      await this.logSuccess(Date.now() - startTime, data.length);

      // 5. WebSocketæ¨é€
      this.notifyWebSocket(data);

      return data;
    } catch (error) {
      await this.logFailure(error);
      throw error;
    }
  }
}
```

### 3. åŸŸåç®¡ç†å™¨ (UniversalDomainManager)

**èŒè´£**: ç®¡ç†å¤šæ•°æ®æºçš„åŸŸåæ± ï¼Œå®ç°è‡ªåŠ¨æ•…éšœè½¬ç§»

**æ ¸å¿ƒåŠŸèƒ½**:
- å¤šåŸŸåæ± ç®¡ç†ï¼ˆæ”¯æŒ9ä¸ªæ•°æ®æºï¼‰
- å¥åº·æ£€æŸ¥ï¼ˆæ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼‰
- ä¼˜å…ˆçº§è°ƒåº¦ï¼ˆpriorityå­—æ®µï¼‰
- è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼ˆè¿ç»­å¤±è´¥3æ¬¡åˆ‡æ¢ï¼‰
- ç»Ÿè®¡ä¿¡æ¯è®°å½•ï¼ˆæˆåŠŸç‡ã€å“åº”æ—¶é—´ï¼‰

**å…³é”®ä»£ç ** (`src/domains/UniversalDomainManager.js`):
```javascript
class UniversalDomainManager {
  async getCurrentDomain(sourceType) {
    // 1. ä»æ•°æ®åº“è·å–å¯ç”¨åŸŸåï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
    const domains = await this.db.query(`
      SELECT * FROM cwl_api_domains
      WHERE source_type = ? AND enabled = 1 AND status != 'failed'
      ORDER BY priority ASC, success_rate DESC
    `, [sourceType]);

    if (domains.length === 0) {
      throw new Error(`No available domains for ${sourceType}`);
    }

    return domains[0].domain_url;
  }

  async switchDomain(sourceType, reason) {
    // 1. æ ‡è®°å½“å‰åŸŸåä¸ºå¤±è´¥
    await this.markDomainFailed(currentDomain);

    // 2. åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªåŸŸå
    const newDomain = await this.getCurrentDomain(sourceType);

    // 3. è®°å½•åˆ‡æ¢å†å²
    await this.logDomainSwitch(currentDomain, newDomain, reason);

    return newDomain;
  }

  async healthCheck() {
    const domains = await this.getAllDomains();

    for (const domain of domains) {
      const startTime = Date.now();
      try {
        const response = await axios.get(domain.domain_url, {timeout: 5000});
        const responseTime = Date.now() - startTime;

        // æ›´æ–°æˆåŠŸç»Ÿè®¡
        await this.updateDomainStats(domain.id, true, responseTime);
      } catch (error) {
        // æ›´æ–°å¤±è´¥ç»Ÿè®¡
        await this.updateDomainStats(domain.id, false, 0, error.message);
      }
    }
  }
}
```

### 4. å‘Šè­¦ç³»ç»Ÿ (AlertManager)

**èŒè´£**: ç›‘æ§ç³»ç»ŸçŠ¶æ€ï¼Œè§¦å‘å‘Šè­¦è§„åˆ™ï¼Œå‘é€é€šçŸ¥

**æ ¸å¿ƒåŠŸèƒ½**:
- è§„åˆ™å¼•æ“ï¼ˆ8æ¡é¢„ç½®è§„åˆ™ï¼‰
- å‘Šè­¦è§¦å‘æ£€æµ‹
- å‘Šè­¦å†å²è®°å½•
- é€šçŸ¥åˆ†å‘ï¼ˆé‚®ä»¶/é’‰é’‰/Webhookï¼‰
- å‘Šè­¦ç»Ÿè®¡

**å…³é”®ä»£ç ** (`src/alerts/AlertManager.js`):
```javascript
class AlertManager {
  async checkCrawlFail(lotCode) {
    // æŸ¥è¯¢æœ€è¿‘10åˆ†é’Ÿå†…çš„å¤±è´¥æ¬¡æ•°
    const failures = await this.db.query(`
      SELECT COUNT(*) as count FROM crawler_logs
      WHERE lot_code = ? AND status = 'failed'
      AND created_at > DATE_SUB(NOW(), INTERVAL 10 MINUTE)
    `, [lotCode]);

    // è·å–å‘Šè­¦è§„åˆ™
    const rule = await this.getRule('crawl_fail');
    const threshold = rule.condition_config.threshold;

    if (failures[0].count >= threshold) {
      // è§¦å‘å‘Šè­¦
      await this.createAlert({
        rule_id: rule.id,
        rule_name: rule.name,
        level: rule.level,
        message: `å½©ç§ ${lotCode} è¿ç»­å¤±è´¥ ${failures[0].count} æ¬¡`,
        lot_code: lotCode,
        metric_value: failures[0].count
      });

      // å‘é€é€šçŸ¥
      await this.notificationManager.send(rule, alert);
    }
  }
}
```

### 5. WebæœåŠ¡å™¨ (WebServer)

**èŒè´£**: æä¾›REST APIå’Œé™æ€æ–‡ä»¶æœåŠ¡

**æ–‡ä»¶è§„æ¨¡**: 5301è¡Œä»£ç ï¼Œ**89ä¸ªAPIæ¥å£** (å»ºè®®åç»­é‡æ„ä¸ºæ¨¡å—åŒ–è·¯ç”±)

**æ ¸å¿ƒåŠŸèƒ½**:
- REST APIæ¥å£ï¼ˆæ•°æ®æŸ¥è¯¢ã€ç³»ç»Ÿç®¡ç†ã€ç›‘æ§å‘Šè­¦ï¼‰
- é™æ€æ–‡ä»¶æœåŠ¡ï¼ˆå‰ç«¯distç›®å½•ï¼‰
- WebSocketæœåŠ¡ï¼ˆå®æ—¶æ•°æ®æ¨é€ï¼‰
- CORSæ”¯æŒ

**APIæ¥å£åˆ†ç±»** (å…±89ä¸ª):

**æ•°æ®æŸ¥è¯¢æ¥å£ (10ä¸ª)**:
```javascript
GET  /api/lotteries              - å½©ç§åˆ—è¡¨
GET  /api/realtime-data          - å®æ—¶æ•°æ®
GET  /api/latest-data            - æœ€æ–°å¼€å¥–
GET  /api/history-data           - å†å²æ•°æ®æŸ¥è¯¢
GET  /api/history/data-range     - æ•°æ®æ—¥æœŸèŒƒå›´
GET  /api/export/csv             - å¯¼å‡ºCSV
GET  /api/status                 - ç³»ç»ŸçŠ¶æ€
GET  /api/sources                - æ•°æ®æºåˆ—è¡¨
POST /api/crawl                  - æ‰‹åŠ¨è§¦å‘çˆ¬å–
POST /api/crawl-history          - çˆ¬å–å†å²æ•°æ®
```

**æ•°æ®ç®¡ç†æ¥å£ (8ä¸ª)**:
```javascript
POST /api/history/backfill-date       - è¡¥å…¨æŒ‡å®šæ—¥æœŸ
POST /api/history/backfill-recent     - è¡¥å…¨æœ€è¿‘æ•°æ®
POST /api/history/auto-backfill       - è‡ªåŠ¨è¡¥å…¨å•å½©ç§
POST /api/history/auto-backfill-all   - è‡ªåŠ¨è¡¥å…¨æ‰€æœ‰å½©ç§
GET  /api/history/detect-missing      - æ£€æµ‹ç¼ºå¤±æ•°æ®
GET  /api/history/active-tasks        - æ´»åŠ¨ä»»åŠ¡åˆ—è¡¨
POST /api/cleanup-sg-data             - æ¸…ç†æ–°åŠ å¡å½©æ•°æ®
GET  /api/logs                        - çˆ¬è™«æ—¥å¿—
```

**æ•°æ®åº“ç®¡ç†æ¥å£ (10ä¸ª)**:
```javascript
GET  /api/database/statistics         - æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯
GET  /api/database/health             - æ•°æ®åº“å¥åº·æ£€æŸ¥
GET  /api/database/suggestions        - ä¼˜åŒ–å»ºè®®
POST /api/database/clean-duplicates   - æ¸…ç†é‡å¤æ•°æ®
POST /api/database/clean-old-data     - æ¸…ç†æ—§æ•°æ®
POST /api/database/optimize           - ä¼˜åŒ–è¡¨ç»“æ„
POST /api/database/full-maintenance   - å®Œæ•´ç»´æŠ¤
```

**ç³»ç»Ÿç›‘æ§æ¥å£ (15+ä¸ª)**:
```javascript
GET  /api/system/overview             - ç³»ç»Ÿæ¦‚è§ˆ
GET  /api/scheduler/stats             - è°ƒåº¦å™¨ç»Ÿè®¡
GET  /api/countdown/stats             - å€’è®¡æ—¶ç»Ÿè®¡
GET  /api/health                      - å¥åº·æ£€æŸ¥
POST /api/system/restart              - é‡å¯ç³»ç»Ÿ
```

**å‘Šè­¦ç³»ç»Ÿæ¥å£ (çº¦10ä¸ª)**:
```javascript
GET  /api/alerts/history              - å‘Šè­¦å†å²
GET  /api/alerts/stats                - å‘Šè­¦ç»Ÿè®¡
POST /api/alerts/acknowledge          - ç¡®è®¤å‘Šè­¦
... (è¯¦è§ docs/API_REFERENCE.md)
```

**åŸŸåç®¡ç†æ¥å£ (çº¦8ä¸ª)**:
```javascript
GET  /api/domains/health              - åŸŸåå¥åº·çŠ¶æ€
POST /api/domains/switch              - åˆ‡æ¢åŸŸå
GET  /api/domains/history             - åˆ‡æ¢å†å²
... (è¯¦è§ docs/API_REFERENCE.md)
```

**å®Œæ•´APIæ–‡æ¡£**: è¯·å‚è€ƒ [docs/API_REFERENCE.md](./docs/API_REFERENCE.md)

### 6. WebSocketç®¡ç†å™¨ (WebSocketManager)

**èŒè´£**: å®æ—¶æ¨é€å¼€å¥–æ•°æ®åˆ°å‰ç«¯

**æ ¸å¿ƒåŠŸèƒ½**:
- WebSocketè¿æ¥ç®¡ç†
- å®æ—¶æ•°æ®æ¨é€
- å¿ƒè·³æ£€æµ‹
- è‡ªåŠ¨é‡è¿

**æ¨é€æ ¼å¼**:
```javascript
{
  type: 'lottery_update',
  lotCode: '10001',
  data: {
    issue: '2026011701',
    drawCode: '01,02,03,04,05,06+07',
    drawTime: '2026-01-17 21:30:00',
    countdown: 278
  }
}
```

### 7. ç®¡ç†å™¨å±‚ (managers/)

**èŒè´£**: èµ„æºç®¡ç†å’Œé…ç½®ç®¡ç†ï¼Œä¸ºçˆ¬è™«å’ŒæœåŠ¡å±‚æä¾›æ”¯æŒ

**æ ¸å¿ƒæ¨¡å—** (`src/managers/`):

#### UniversalDomainManager.js
- é€šç”¨åŸŸåç®¡ç†å™¨ï¼ˆæ–‡æ¡£å·²è¯¦ç»†è¯´æ˜ï¼‰
- æ”¯æŒå¤šæ•°æ®æºåŸŸåæ± ç®¡ç†
- å¥åº·æ£€æŸ¥å’Œè‡ªåŠ¨æ•…éšœè½¬ç§»

#### CWLDomainManager.js
- ä¸­å›½ç¦å½©ä¸“ç”¨åŸŸåç®¡ç†å™¨
- é’ˆå¯¹å®˜æ–¹åŸŸåç‰¹æ€§ä¼˜åŒ–
- æ”¯æŒå¤‡ç”¨åŸŸåè‡ªåŠ¨åˆ‡æ¢

#### LotteryConfigManager.js
- å½©ç§é…ç½®ç®¡ç†å™¨
- ä»æ•°æ®åº“åŠ è½½å½©ç§é…ç½®
- åŠ¨æ€æ›´æ–°å½©ç§å‚æ•°

#### OfficialSourceManager.js
- å®˜æ–¹æ•°æ®æºç®¡ç†å™¨
- ç®¡ç†å®˜æ–¹APIé…ç½®
- æ•°æ®æºä¼˜å…ˆçº§è°ƒåº¦

**å…³é”®ä»£ç ** (`src/managers/LotteryConfigManager.js`):
```javascript
class LotteryConfigManager {
  async loadConfigs() {
    // ä»æ•°æ®åº“åŠ è½½æ‰€æœ‰å½©ç§é…ç½®
    const configs = await this.db.query(`
      SELECT * FROM lottery_configs WHERE enabled = 1
    `);

    this.configMap = new Map();
    for (const config of configs) {
      this.configMap.set(config.lot_code, {
        lotName: config.lot_name,
        category: config.category,
        frequency: config.polling_interval,
        scraperClass: config.scraper_class
      });
    }
  }

  getConfig(lotCode) {
    return this.configMap.get(lotCode);
  }
}
```

### 8. æœåŠ¡å±‚ (services/)

**èŒè´£**: ä¸šåŠ¡é€»è¾‘å°è£…ï¼Œä¸ºWeb Serverå’Œè°ƒåº¦å™¨æä¾›é«˜å±‚æœåŠ¡

**æ ¸å¿ƒæ¨¡å—** (`src/services/`):

#### DataCompletionService.js
- æ•°æ®è¡¥å…¨æœåŠ¡
- æ£€æµ‹ç¼ºå¤±æ•°æ®
- è‡ªåŠ¨è§¦å‘å†å²æ•°æ®å›å¡«

**åŠŸèƒ½**:
```javascript
// æ£€æµ‹æŒ‡å®šæ—¥æœŸçš„æ•°æ®å®Œæ•´æ€§
async checkDataCompleteness(lotCode, date);

// è‡ªåŠ¨è¡¥å…¨ç¼ºå¤±æ•°æ®
async autoBackfill(lotCode, startDate, endDate);

// è®°å½•è¡¥å…¨å†å²
async logCompletionHistory(lotCode, date, recordsAdded);
```

#### MultiSourceDataManager.js
- å¤šæ•°æ®æºæ•°æ®ç®¡ç†å™¨
- å®˜æ–¹æºå’Œç¬¬ä¸‰æ–¹æºæ•°æ®åˆå¹¶
- æ•°æ®å»é‡å’Œä¼˜å…ˆçº§å¤„ç†

#### CacheService.js
- ç¼“å­˜æœåŠ¡ï¼ˆå¯é€‰Redisæ”¯æŒï¼‰
- å½©ç§åˆ—è¡¨ç¼“å­˜
- æœ€æ–°æ•°æ®ç¼“å­˜
- å‡å°‘æ•°æ®åº“æŸ¥è¯¢å‹åŠ›

#### SnowballRecognitionService.js
- é‡‘å¤šå®è¯†åˆ«æœåŠ¡
- æ™ºèƒ½è¯†åˆ«ç‰¹æ®ŠæœŸå·
- åˆ†ç±»ç®¡ç†ï¼ˆèŠ‚æ—¥/çºªå¿µ/ç‰¹æ®Šï¼‰
- è¯¦è§"å…³é”®è®¾è®¡ - é‡‘å¤šå®è¯†åˆ«"

#### AlertService.js & AlertServiceManager.js
- å‘Šè­¦æœåŠ¡å’Œç®¡ç†å™¨
- è¯¦è§"æ¨¡å—è¯´æ˜ - å‘Šè­¦ç³»ç»Ÿ"

#### SettingsService.js
- ç³»ç»Ÿè®¾ç½®æœåŠ¡
- è¯»å–/æ›´æ–°ç³»ç»Ÿé…ç½®
- æ”¯æŒåŠ¨æ€é…ç½®æ›´æ–°

---

## æ•°æ®æµè½¬

### 1. å®æ—¶çˆ¬å–æµç¨‹

```
å®šæ—¶å™¨è§¦å‘
    â†“
è°ƒåº¦å™¨é€‰æ‹©å½©ç§
    â†“
è·å–Scraperå®ä¾‹
    â†“
åŸŸåç®¡ç†å™¨è·å–å¯ç”¨åŸŸå
    â†“
å‘é€HTTPè¯·æ±‚
    â†“
è§£æå“åº”æ•°æ®
    â†“
æ•°æ®éªŒè¯
    â†“
ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆlottery_resultsï¼‰
    â†“
è®°å½•æ—¥å¿—ï¼ˆcrawler_logsï¼‰
    â†“
WebSocketæ¨é€åˆ°å‰ç«¯
    â†“
å‘Šè­¦ç³»ç»Ÿæ£€æŸ¥
```

### 2. å‰ç«¯æŸ¥è¯¢æµç¨‹

```
ç”¨æˆ·è®¿é—®é¡µé¢
    â†“
å»ºç«‹WebSocketè¿æ¥
    â†“
HTTPè¯·æ±‚è·å–åˆå§‹æ•°æ®
    â†“
æ¥æ”¶WebSocketå®æ—¶æ¨é€
    â†“
æœ¬åœ°å€’è®¡æ—¶è®¡ç®—
    â†“
æ–°å¼€å¥–æ—¶è‡ªåŠ¨åˆ·æ–°
```

### 3. åŸŸåæ•…éšœè½¬ç§»æµç¨‹

```
çˆ¬å–å¤±è´¥ï¼ˆè¿ç»­3æ¬¡ï¼‰
    â†“
åŸŸåç®¡ç†å™¨æ ‡è®°å½“å‰åŸŸåä¸ºfailed
    â†“
ä»æ•°æ®åº“è·å–å¤‡ç”¨åŸŸåï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰
    â†“
åˆ‡æ¢åˆ°æ–°åŸŸå
    â†“
è®°å½•åˆ‡æ¢å†å²ï¼ˆcwl_domain_switch_historyï¼‰
    â†“
å¥åº·æ£€æŸ¥ä»»åŠ¡å®šæœŸæ£€æµ‹ï¼ˆæ¯åˆ†é’Ÿï¼‰
    â†“
æˆåŠŸåæ¢å¤åŸŸåçŠ¶æ€
```

### 4. å‘Šè­¦è§¦å‘æµç¨‹

```
çˆ¬å–å¤±è´¥/æ•°æ®å¼‚å¸¸
    â†“
å‘Šè­¦ç®¡ç†å™¨æ£€æŸ¥è§„åˆ™
    â†“
æ¡ä»¶åŒ¹é…ï¼ˆå¦‚è¿ç»­å¤±è´¥3æ¬¡ï¼‰
    â†“
åˆ›å»ºå‘Šè­¦è®°å½•ï¼ˆalert_historyï¼‰
    â†“
é€šçŸ¥ç®¡ç†å™¨å‘é€é€šçŸ¥
    â”œâ”€ é‚®ä»¶é€šçŸ¥
    â”œâ”€ é’‰é’‰é€šçŸ¥
    â””â”€ Webhooké€šçŸ¥
    â†“
æ›´æ–°å‘Šè­¦ç»Ÿè®¡ï¼ˆalert_stats_todayï¼‰
```

---

## å…³é”®è®¾è®¡

### 1. å¤šæ•°æ®æºæ¶æ„

**è®¾è®¡åŸåˆ™**: æ¯ä¸ªæ•°æ®æºç‹¬ç«‹ç®¡ç†ï¼Œé¿å…å•ç‚¹æ•…éšœ

**å®ç°æ–¹å¼**:
- æ¯ä¸ªæ•°æ®æºæœ‰ç‹¬ç«‹çš„åŸŸåæ± ï¼ˆcwl_api_domainsè¡¨ï¼‰
- ä¼˜å…ˆçº§è°ƒåº¦ï¼ˆpriorityå­—æ®µï¼Œæ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼‰
- å¥åº·æ£€æŸ¥ï¼ˆæ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼Œè‡ªåŠ¨æ ‡è®°failedçŠ¶æ€ï¼‰
- è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼ˆè¿ç»­å¤±è´¥3æ¬¡è‡ªåŠ¨åˆ‡æ¢ï¼‰

**ç¤ºä¾‹é…ç½®**:
```sql
-- CWLæ•°æ®æºæœ‰3ä¸ªåŸŸå
INSERT INTO cwl_api_domains (source_type, domain_url, priority) VALUES
('cwl', 'https://www.cwl.gov.cn', 1),         -- ä¸»åŸŸå
('cwl', 'https://auluckylotteries.com', 2),   -- å¤‡ç”¨1
('cwl', 'https://backup.cwl.com', 3);         -- å¤‡ç”¨2
```

### 2. è°ƒåº¦ç­–ç•¥

**é—®é¢˜**: å¦‚ä½•é¿å…ä¸5åˆ†é’Ÿå‘¨æœŸå†²çªï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**: é«˜é¢‘å½©ä½¿ç”¨75ç§’è½®è¯¢ï¼ˆè€Œé60ç§’ï¼‰

**åŸå› **:
- 75ç§’ä¸300ç§’ï¼ˆ5åˆ†é’Ÿï¼‰çš„æœ€å°å…¬å€æ•°æ˜¯300ç§’
- é¿å…é«˜é¢‘å½©å’Œä½é¢‘å½©åœ¨åŒä¸€æ—¶åˆ»æ‰§è¡Œ
- å‡å°‘æ•°æ®åº“å¹¶å‘å‹åŠ›

**ç¤ºä¾‹**:
```
æ—¶é—´è½´:
0ç§’   â†’ é«˜é¢‘å½©æ‰§è¡Œ
75ç§’  â†’ é«˜é¢‘å½©æ‰§è¡Œ
150ç§’ â†’ é«˜é¢‘å½©æ‰§è¡Œ
225ç§’ â†’ é«˜é¢‘å½©æ‰§è¡Œ
300ç§’ â†’ ä½é¢‘å½©æ‰§è¡Œ + é«˜é¢‘å½©æ‰§è¡Œ
```

### 3. é‡‘å¤šå®è¯†åˆ«

**åœºæ™¯**: é¦™æ¸¯å…­åˆå½©åœ¨ç‰¹æ®ŠèŠ‚æ—¥ä¼šæ›´æ”¹æœŸå·åç§°ä¸º"é‡‘å¤šå®"

**å®ç°**: æ™ºèƒ½è¯†åˆ«å™¨ + æ•°æ®åº“å­—æ®µ

**å­—æ®µè®¾è®¡**:
```sql
-- lottery_resultsè¡¨
snowball_name VARCHAR(100)        -- é‡‘å¤šå®åç§°ï¼ˆå¦‚ï¼šæ–°æ˜¥é‡‘å¤šå®ï¼‰
snowball_type VARCHAR(50)         -- ç±»å‹ä»£ç ï¼ˆCHINESE_NEW_YEARï¼‰
snowball_category VARCHAR(30)     -- åˆ†ç±»ï¼ˆfestival/commemorative/specialï¼‰
snowball_confidence DECIMAL(3,2)  -- è¯†åˆ«ç½®ä¿¡åº¦ï¼ˆ0.00-1.00ï¼‰
```

**è¯†åˆ«é€»è¾‘** (`src/utils/snowballRecognizer.js`):
```javascript
function recognizeSnowball(issue, drawTime) {
  // 1. æ£€æµ‹æœŸå·ä¸­çš„å…³é”®è¯
  if (/æ–°æ˜¥|æ˜¥èŠ‚|å†œå†æ–°å¹´/.test(issue)) {
    return {
      name: 'æ–°æ˜¥é‡‘å¤šå®',
      type: 'CHINESE_NEW_YEAR',
      category: 'festival',
      confidence: 0.95
    };
  }

  // 2. æ£€æµ‹æ—¥æœŸèŒƒå›´ï¼ˆå¦‚ä¸­ç§‹èŠ‚å‰åï¼‰
  if (isMidAutumnPeriod(drawTime)) {
    return {
      name: 'ä¸­ç§‹é‡‘å¤šå®',
      type: 'MID_AUTUMN',
      category: 'festival',
      confidence: 0.90
    };
  }

  return null; // éé‡‘å¤šå®æœŸå·
}
```

### 4. å€’è®¡æ—¶åŒæ­¥

**é—®é¢˜**: å‰ç«¯å€’è®¡æ—¶ä¸åç«¯ä¸åŒæ­¥

**è§£å†³æ–¹æ¡ˆ**: æ··åˆç­–ç•¥

1. **åˆå§‹åŠ è½½**: ä½¿ç”¨HTTP APIè¿”å›çš„å€’è®¡æ—¶
2. **å®æ—¶æ›´æ–°**: æ¥æ”¶WebSocketæ¨é€çš„å€’è®¡æ—¶
3. **æœ¬åœ°è®¡ç®—**: å‰ç«¯æ¯ç§’é€’å‡å€’è®¡æ—¶
4. **æ ¡å‡†æœºåˆ¶**: WebSocketæ¨é€æ—¶æ ¡å‡†å‰ç«¯å€’è®¡æ—¶

**å‰ç«¯ä»£ç ** (`src/web/vue-app/src/views/RealtimeElementPlus.vue`):
```javascript
// 1. æ¥æ”¶WebSocketæ¨é€
socket.on('lottery_update', (data) => {
  lottery.countdown = data.countdown; // æ ¡å‡†å€’è®¡æ—¶
  lottery.issue = data.issue;
  lottery.drawCode = data.drawCode;
});

// 2. æœ¬åœ°å€’è®¡æ—¶
setInterval(() => {
  if (lottery.countdown > 0) {
    lottery.countdown--;
  } else {
    // å€’è®¡æ—¶ç»“æŸï¼Œç­‰å¾…æ–°æœŸå·
  }
}, 1000);
```

### 5. æ•°æ®è¡¥å…¨æœºåˆ¶

**åœºæ™¯**: æœåŠ¡å™¨é‡å¯æˆ–æ•…éšœå¯¼è‡´å†å²æ•°æ®ç¼ºå¤±

**å®ç°**: è‡ªåŠ¨æ£€æµ‹ + æ‰‹åŠ¨è¡¥å…¨

**è‡ªåŠ¨æ£€æµ‹**:
```javascript
// æ¯å¤©å‡Œæ™¨2ç‚¹æ£€æµ‹å‰ä¸€å¤©æ•°æ®å®Œæ•´æ€§
cron.schedule('0 2 * * *', async () => {
  const yesterday = moment().subtract(1, 'day').format('YYYY-MM-DD');

  for (const lotCode of highFrequencyLotteries) {
    // æŸ¥è¯¢æ˜¨å¤©çš„è®°å½•æ•°
    const count = await db.query(`
      SELECT COUNT(*) as count FROM lottery_results
      WHERE lot_code = ? AND DATE(draw_time) = ?
    `, [lotCode, yesterday]);

    // é«˜é¢‘å½©æ¯å¤©åº”è¯¥æœ‰1152æœŸï¼ˆ5åˆ†é’Ÿ/æœŸï¼‰
    if (count[0].count < 1100) {
      // è§¦å‘è¡¥å…¨ä»»åŠ¡
      await backfillHistory(lotCode, yesterday);
    }
  }
});
```

**æ‰‹åŠ¨è¡¥å…¨**:
```bash
# è¡¥å…¨æŒ‡å®šå½©ç§çš„å†å²æ•°æ®
node scripts/backfill-history.js --lottery=10035 --date=2026-01-15
```

---

## æ€§èƒ½ä¼˜åŒ–

### 1. æ•°æ®åº“ä¼˜åŒ–

**ç´¢å¼•è®¾è®¡**:
```sql
-- lottery_resultsè¡¨
UNIQUE KEY uk_lot_issue (lot_code, issue)     -- é˜²æ­¢é‡å¤
KEY idx_lot_code (lot_code)                   -- å½©ç§æŸ¥è¯¢
KEY idx_draw_time (draw_time)                 -- æ—¶é—´èŒƒå›´æŸ¥è¯¢
KEY idx_created_at (created_at)               -- æ—¥å¿—æŸ¥è¯¢
KEY idx_snowball_type_time (snowball_type, draw_time) -- é‡‘å¤šå®æŸ¥è¯¢
```

**æŸ¥è¯¢ä¼˜åŒ–**:
```sql
-- é¿å…å…¨è¡¨æ‰«æï¼Œä½¿ç”¨ç´¢å¼•
SELECT * FROM lottery_results
WHERE lot_code = '10001'
  AND draw_time >= '2026-01-01'
ORDER BY draw_time DESC
LIMIT 50;

-- ä½¿ç”¨è¦†ç›–ç´¢å¼•
SELECT lot_code, issue, draw_time FROM lottery_results
WHERE lot_code = '10001'
LIMIT 1;
```

### 2. å¹¶å‘æ§åˆ¶

**é—®é¢˜**: å¤šä¸ªå½©ç§å¹¶å‘çˆ¬å–å¯¼è‡´æ•°æ®åº“è¿æ¥è€—å°½

**è§£å†³æ–¹æ¡ˆ**:
- è¿æ¥æ± ï¼ˆæœ€å¤§è¿æ¥æ•°10ï¼‰
- ä»»åŠ¡é˜Ÿåˆ—ï¼ˆåŒæ—¶æœ€å¤š5ä¸ªçˆ¬å–ä»»åŠ¡ï¼‰
- é‡å¤ä»»åŠ¡æ£€æµ‹ï¼ˆrunningTasks Setï¼‰

### 3. å†…å­˜ä¼˜åŒ–

**é—®é¢˜**: å¤§é‡å†å²æ•°æ®æŸ¥è¯¢å¯¼è‡´å†…å­˜æº¢å‡º

**è§£å†³æ–¹æ¡ˆ**:
- åˆ†é¡µæŸ¥è¯¢ï¼ˆæ¯é¡µæœ€å¤š100æ¡ï¼‰
- æµå¼æŸ¥è¯¢ï¼ˆä½¿ç”¨Streamè€Œéä¸€æ¬¡æ€§åŠ è½½ï¼‰
- å®šæœŸæ¸…ç†æ—¥å¿—ï¼ˆä¿ç•™30å¤©ï¼‰

---

## æ‰©å±•æ€§è®¾è®¡

### 1. æ·»åŠ æ–°å½©ç§

åªéœ€3æ­¥ï¼š

1. **åˆ›å»ºScraperç±»**:
```javascript
// src/scrapers/NewLotteryScraper.js
class NewLotteryScraper extends BaseScraper {
  async fetchData() {
    // å®ç°æ•°æ®è·å–é€»è¾‘
  }
}
```

2. **æ³¨å†Œåˆ°é…ç½®**:
```javascript
// src/config/crawlerConfig.js
module.exports = {
  lotteries: [
    {
      lotCode: '10099',
      lotName: 'æ–°å½©ç§',
      category: 'high',
      scraperClass: 'NewLotteryScraper',
      source: 'new_source'
    }
  ]
};
```

3. **æ·»åŠ åŸŸåé…ç½®**:
```sql
INSERT INTO cwl_api_domains (source_type, domain_url, priority)
VALUES ('new_source', 'https://newsource.com', 1);
```

è¯¦ç»†æ­¥éª¤ï¼š[docs/ADD_NEW_DATASOURCE.md](./docs/ADD_NEW_DATASOURCE.md)

### 2. æ·»åŠ æ–°æ•°æ®æº

å‚è€ƒæ–‡æ¡£ï¼š[docs/SCRAPER_TEMPLATE.md](./docs/SCRAPER_TEMPLATE.md)

### 3. æ·»åŠ æ–°å‘Šè­¦è§„åˆ™

```sql
INSERT INTO alert_rules (name, rule_type, condition_config, level, enabled, notification_channels, description)
VALUES (
  'æ–°è§„åˆ™åç§°',
  'custom_type',
  '{"threshold": 5, "timeWindow": 600}',
  'warning',
  1,
  '["email", "dingtalk"]',
  'è§„åˆ™æè¿°'
);
```

---

## ç›¸å…³æ–‡æ¡£

- [éƒ¨ç½²æŒ‡å—.md](./éƒ¨ç½²æŒ‡å—.md) - éƒ¨ç½²å’Œè¿ç»´
- [å‰ç«¯æ¶æ„è¯´æ˜.md](./å‰ç«¯æ¶æ„è¯´æ˜.md) - å‰ç«¯æŠ€æœ¯ç»†èŠ‚
- [å‰ç«¯æ„å»ºä¸éƒ¨ç½²æŒ‡å—.md](./å‰ç«¯æ„å»ºä¸éƒ¨ç½²æŒ‡å—.md) - å‰ç«¯å¼€å‘æµç¨‹
- [docs/ALERT_SYSTEM.md](./docs/ALERT_SYSTEM.md) - å‘Šè­¦ç³»ç»Ÿè¯¦è§£
- [docs/MULTI_SOURCE_ARCHITECTURE.md](./docs/MULTI_SOURCE_ARCHITECTURE.md) - å¤šæ•°æ®æºæ¶æ„
- [docs/DATABASE_OPTIMIZATION.md](./docs/DATABASE_OPTIMIZATION.md) - æ•°æ®åº“ä¼˜åŒ–
